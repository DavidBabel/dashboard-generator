# Version: 1.0.3
# âœ… working
# Appartement: Tous
blueprint:
  name: "ðŸ›‘ Auto-stop Add-on aprÃ¨s dÃ©lai"
  description: ArrÃªte un add-on spÃ©cifique aprÃ¨s un temps dÃ©fini en Ã©teignant le switch associÃ©.
  domain: automation
  input:
    running_sensor:
      name: Capteur â€œadd-on en cours d'exÃ©cutionâ€
      description: >
        Binary sensor qui passe Ã  on quand l'add-on tourne.
        A activer dans l'addon qu'on veut surveiller.
        âš ï¸ Attention Ã  Ã©galement activer le switch de l'app
        Exemple : binary_sensor.advanced_ssh_web_terminal_en_cours_d_execution
      default: binary_sensor.advanced_ssh_web_terminal_en_cours_d_execution
      selector:
        entity:
          domain: binary_sensor
    running_duration:
      name: DurÃ©e de fonctionnement
      description: Temps (en minutes) avant d'arrÃªter l'add-on
      default: 30
      selector:
        number:
          min: 1
          max: 120
          unit_of_measurement: minutes

variables:
  running_sensor: !input running_sensor
  app_switch: >
    {% set raw = running_sensor.split('.')[1] if '.' in running_sensor else running_sensor %}
    {% set raw = raw | regex_replace('_en_cours_d_execution$', '') %}
    {{ 'switch.' ~ raw }}

trigger:
  - platform: state
    entity_id: !input running_sensor
    to: "on"
    for:
      minutes: !input running_duration

action:
  - service: switch.turn_off
    target:
      entity_id: "{{ app_switch }}"
