# Version: 1.1.5
# ‚úÖ working
# Appartement: Romains
blueprint:
  name: "üïµÔ∏è Warning ‚Äì Capteur de Pr√©sence Potentiellement Cach√©"
  description: >
    Version: 1.1.5
    Envoie une alerte lorsqu'un capteur de pr√©sence d√©tecte tr√®s peu d'activit√©
    pendant plusieurs jours (indicateur qu'il est peut-√™tre cach√© ou d√©faillant).
  domain: automation
  # ==============================================================================
  # INPUTS - Configuration des param√®tres du blueprint
  # ==============================================================================
  input:
    # --------------------------------------------------------------------------
    # Sensor de statistiques : calcule la moyenne de d√©tection
    # Type attendu : sensor.xxx cr√©√© via "statistics" dans configuration.yaml
    # Valeur attendue : pourcentage entre 0 et 100
    # --------------------------------------------------------------------------
    presence_statistics_sensor:
      name: üìä Capteur de statistiques de pr√©sence
      description: >
        Le sensor de type "statistics" qui calcule la moyenne de d√©tection
        (cr√©ez-le d'abord avec la config ci-dessus)
      default: sensor.presence_romains_detection_percent
      selector:
        entity:
          domain: sensor

    # --------------------------------------------------------------------------
    # Seuil de pr√©sence : valeur de r√©f√©rence pour comparer le sensor
    # Type attendu : input_number.xxx (Helper > Number)
    # Valeur attendue : pourcentage entre 0 et 100
    # Cr√©er via UI : Settings > Devices & Services > Helpers > Create Helper > Number
    # --------------------------------------------------------------------------
    presence_threshold:
      name: üéöÔ∏è Seuil de pr√©sence minimum (%)
      description: >
        Si la moyenne de d√©tection est inf√©rieure √† ce pourcentage pendant
        la dur√©e configur√©e, une alerte sera envoy√©e
      default: input_number.seuil_presence_minimum_romains
      selector:
        entity:
          domain: input_number

    # --------------------------------------------------------------------------
    # Dur√©e avant alerte : temps d'attente avant notification
    # --------------------------------------------------------------------------
    check_duration:
      name: ‚è≥ Dur√©e de surveillance
      description: >
        Temps pendant lequel le pourcentage doit rester sous le seuil
        avant d'envoyer l'alerte  (minimum 1 heure pour les tests)
      default: 2
      selector:
        number:
          min: 0
          max: 10
          step: 0.1
          unit_of_measurement: jours

    # --------------------------------------------------------------------------
    # Device de notification : appareil mobile recevant les alertes
    # Type attendu : device avec l'app mobile Home Assistant install√©e
    # --------------------------------------------------------------------------
    notify_device:
      name: üì± Device √† notifier
      description: >
        Le device doit utiliser l'application mobile officielle Home Assistant.
      selector:
        device:
          filter:
            integration: mobile_app

# ==============================================================================
# VARIABLES : Pr√©paration des donn√©es pour les conditions et actions
# ==============================================================================
variables:
  presence_stats_sensor: !input presence_statistics_sensor
  presence_threshold_entity: !input presence_threshold
  notify_device: !input notify_device

  # Service de notification dynamique bas√© sur le nom du device
  notify_service: >
    notify.mobile_app_{{ device_attr(notify_device, 'name')
      | lower
      | replace(' ', '_')
      | replace('-', '_') }}

  # Nom convivial du sensor
  sensor_name: >
    {{ state_attr(presence_stats_sensor, 'friendly_name') | default(presence_stats_sensor.split('.')[1] | replace('_', ' ') | title) }}

# ==============================================================================
# TRIGGERS : V√©rification quotidienne √† 13h et 20h
# ==============================================================================
trigger:
  - platform: time
    id: check
    at:
      - "13:05:00"
      - "20:05:00"

# ==============================================================================
# ACTIONS
# ==============================================================================
action:
  # Debug logs pour v√©rifier les variables calcul√©es
  - service: system_log.write
    data:
      message: >
        [Nobody Detected Debug]
        Presence Stats Sensor: {{ presence_stats_sensor }}
        Valeur Stats Sensor: {{ states(presence_stats_sensor) }}
        Presence Threshold Entity: {{ presence_threshold_entity }}
        Valeur Threshold: {{ states(presence_threshold_entity) }}
        Notify Service: {{ notify_service }}
        Sensor Name: {{ sensor_name }}
        Ratio: {{ states(presence_stats_sensor) | float(0) }}
        Seuil: {{ states(presence_threshold_entity) | float(0) }}
        Condition (ratio < seuil): {{ states(presence_stats_sensor) | float(0) < states(presence_threshold_entity) | float(0) }}
      level: info

  - choose:
      # ----------------------------------------------------------------------
      # CAS 1 : D√©tection faible ‚Üí Envoi d'alerte
      # ----------------------------------------------------------------------
      - conditions:
          - condition: template
            value_template: "{{ states(presence_stats_sensor) not in ['unknown', 'unavailable', ''] }}"
          - condition: template
            value_template: >
              {% set ratio = states(presence_stats_sensor) | float(0) %}
              {% set seuil = states(presence_threshold_entity) | float(0) %}
              {{ ratio < seuil }}
        sequence:
          - service: "{{ notify_service }}"
            data:
              title: "‚ö†Ô∏è {{ sensor_name }}"
              message: >
                Le capteur d√©tecte tr√®s peu d'activit√© ({{ states(presence_stats_sensor) }}% < {{ states(presence_threshold_entity) }}%).
                Il est peut-√™tre cach√© ou d√©faillant.
              data:
                notification_icon: mdi:motion-sensor-off
                tag: "alerte_presence_{{ presence_stats_sensor | replace('.', '_') }}"
                url: /presence-salon/
                clickAction: /presence-salon/
                actions:
                  - action: "URI"
                    title: "Voir capteurs"
                    uri: "/presence-salon/"
