# Version: 1.0.6
# âœ… working
# Appartement: Carmes
blueprint:
  name: "â¤ï¸ Health Check â€“ Surveillance Serveurs (Scrape)"
  description: >
    Version: 1.0.6
    Surveille vos capteurs de santÃ© (Scrape).
    Envoie une notification critique si l'Ã©tat n'est plus "OK" avec rappel pÃ©riodique.
    A ete crÃ©Ã© pour le home assistant maitre uniquement
  domain: automation
  # ==============================================================================
  # INPUTS - Configuration des paramÃ¨tres du blueprint
  # ==============================================================================
  input:
    # --------------------------------------------------------------------------
    # Capteurs de Health Check : sensors Scrape surveillant l'Ã©tat des serveurs
    # Type attendu : sensor.xxx (crÃ©Ã©s via intÃ©gration Scrape)
    # Valeur attendue : "OK" = en ligne, autre = problÃ¨me
    # CrÃ©er via : Configuration > IntÃ©grations > Scrape
    # --------------------------------------------------------------------------
    capteurs:
      name: ğŸ–¥ï¸ Capteurs de Health check
      description: SÃ©lectionne les entitÃ©s Scrape (doivent renvoyer OK ou KO)
      default:
        - sensor.statut_systeme_ha_romains
        - sensor.statut_systeme_ha_engel
      selector:
        entity:
          domain: sensor
          multiple: true

    # --------------------------------------------------------------------------
    # Intervalle de rappel : frÃ©quence des notifications rÃ©pÃ©titives
    # Type attendu : nombre entier
    # Valeur attendue : durÃ©e en minutes (recommandÃ© : 10)
    # --------------------------------------------------------------------------
    delai_rappel:
      name: ğŸ” Intervalle de rappel
      description: Temps entre deux notifications tant que le serveur est hors-ligne.
      default: 10
      selector:
        number:
          min: 1
          max: 120
          unit_of_measurement: minutes

    # --------------------------------------------------------------------------
    # Device de notification : appareil mobile recevant les alertes
    # Type attendu : device avec l'app mobile Home Assistant installÃ©e
    # --------------------------------------------------------------------------
    notify_device:
      name: ğŸ“± Device Ã  notifier
      description: Le device doit utiliser l'application mobile officielle Home Assistant.
      selector:
        device:
          filter:
            integration: mobile_app

# ==============================================================================
# MODE PARALLEL : Permet de surveiller plusieurs serveurs simultanÃ©ment
# ==============================================================================
mode: parallel
max: 10

# ==============================================================================
# TRIGGERS : Ã‰vÃ©nements qui dÃ©clenchent l'automation
# ==============================================================================
trigger:
  # --------------------------------------------------------------------------
  # Trigger 1 : Serveur en panne (statut != OK)
  # Se dÃ©clenche quand : l'Ã©tat du sensor change et n'est plus "OK"
  # Objectif : dÃ©tecter immÃ©diatement une panne de serveur
  # --------------------------------------------------------------------------
  - platform: state
    entity_id: !input capteurs
    id: alerte
    # DÃ©clenche si l'Ã©tat change et n'est plus "OK"
    not_to: "OK"

  # --------------------------------------------------------------------------
  # Trigger 2 : Serveur rÃ©tabli (statut = OK)
  # Se dÃ©clenche quand : l'Ã©tat du sensor repasse Ã  "OK"
  # Objectif : notifier le retour Ã  la normale
  # Note : Le dÃ©lai 'for' Ã©vite les fausses notifications au redÃ©marrage de HA
  # --------------------------------------------------------------------------
  - platform: state
    entity_id: !input capteurs
    to: "OK"
    for:
      minutes: 2
    id: retour

# ==============================================================================
# VARIABLES : PrÃ©paration des donnÃ©es pour les notifications
# ==============================================================================
variables:
  capteur: "{{ trigger.entity_id }}"
  nom: "{{ state_attr(trigger.entity_id, 'friendly_name') }}"
  rappel: !input delai_rappel
  notify_device: !input notify_device
  notify_service: >
    notify.mobile_app_{{ device_attr(notify_device, 'name')
      | lower
      | replace(' ', '_')
      | replace('-', '_') }}

action:
  - choose:
      # =========================
      # ğŸš¨ SERVEUR OFFLINE (KO)
      # =========================
      - conditions:
          - condition: trigger
            id: alerte
        sequence:
          - repeat:
              while:
                - condition: template
                  value_template: "{{ states(capteur) != 'OK' }}"
              sequence:
                - service: "{{ notify_service }}"
                  data:
                    title: "ğŸš¨ SERVEUR EN PANNE"
                    message: >
                      âš ï¸ L'instance Home Assistant est injoignable !
                      ğŸ“ {{ nom }}
                      Statut actuel : {{ states(capteur) }}
                    data:
                      tag: "health_{{ capteur }}"
                      notification_icon: mdi:server-off
                      push:
                        sound:
                          name: default
                          critical: 1
                          volume: 1.0
                      ttl: 0
                      priority: high
                      clickAction: /dashboard-locatif/
                      url: /dashboard-locatif/

                - delay:
                    minutes: "{{ rappel | int }}"

      # =========================
      # âœ… RETOUR EN LIGNE (OK)
      # =========================
      - conditions:
          - condition: trigger
            id: retour
        sequence:
          - service: "{{ notify_service }}"
            data:
              title: "âœ… Serveur rÃ©tabli"
              message: >
                ğŸŸ¢ L'instance est de nouveau en ligne.
                ğŸ“ {{ nom }}
              data:
                tag: "health_{{ capteur }}"
                notification_icon: mdi:server-network
                clickAction: /dashboard-locatif/
                url: /dashboard-locatif/
