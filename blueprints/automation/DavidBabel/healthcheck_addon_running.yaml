# Version: 1.0.4
# ‚úÖ working
# Appartement: Tous
blueprint:
  name: "ü©∫ Healthcheck - Add-on -"
  description: >
    TODO : essayer de restart l'addon en plus ?
    Version: 1.0.4
    Envoie une alerte quand un add-on (ou service) passe √† l'√©tat arr√™t√©, puis une notification
    de retour √† la normale quand il red√©marre.

    Ce blueprint se base sur un binary_sensor "en cours d'ex√©cution" (on = tourne, off = arr√™t√©)
    expos√© par l'add-on (ou par Supervisor).
  domain: automation
  # ==============================================================================
  # INPUTS - Configuration des param√®tres du blueprint
  # ==============================================================================
  input:
    # --------------------------------------------------------------------------
    # Capteur ‚Äúen cours d'ex√©cution‚Äù
    # Type attendu : binary_sensor.xxx
    # Valeur attendue : on = service/add-on en cours d'ex√©cution ; off = arr√™t√©
    # Comment obtenir : activer l'entit√© dans l'add-on / Supervisor si disponible
    # --------------------------------------------------------------------------
    running_sensor:
      name: üß© Capteur ‚Äúen cours d'ex√©cution‚Äù
      description: >
        Binary sensor qui passe √† on quand l'add-on tourne.
        Exemple : binary_sensor.advanced_ssh_web_terminal_en_cours_d_execution
      default: binary_sensor.advanced_ssh_web_terminal_en_cours_d_execution
      selector:
        entity:
          domain: binary_sensor

    # --------------------------------------------------------------------------
    # D√©lai avant alerte ‚Äúarr√™t√©‚Äù
    # Type attendu : nombre entier
    # Valeur attendue : minutes
    # --------------------------------------------------------------------------
    down_for_minutes:
      name: ‚è±Ô∏è D√©lai avant alerte (minutes)
      description: >
        Evite les faux positifs lors des micro-coupures / red√©marrages.
      default: 5
      selector:
        number:
          min: 0
          max: 120
          step: 1
          unit_of_measurement: minutes

    # --------------------------------------------------------------------------
    # Device de notification : appareil mobile recevant les alertes
    # Type attendu : device avec l'app mobile Home Assistant install√©e
    # --------------------------------------------------------------------------
    notify_device:
      name: üì± Device √† notifier
      description: >
        Le device doit utiliser l'application mobile officielle Home Assistant.
      selector:
        device:
          filter:
            integration: mobile_app

# ==============================================================================
# MODE RESTART : permet de stopper le rappel d√®s que le service red√©marre
# ==============================================================================
mode: restart

# ==============================================================================
# VARIABLES : Pr√©paration des donn√©es pour les notifications
# ==============================================================================
variables:
  running_sensor: !input running_sensor

  service_name: >
    {% set raw = running_sensor.split('.')[1] if '.' in running_sensor else running_sensor %}
    {% set raw = raw | regex_replace('_en_cours_d_execution$', '') %}
    {% set raw = raw | regex_replace('^advanced_', '') %}
    {{ raw | replace('_', ' ') | trim }}

  notify_device: !input notify_device
  notify_service: >
    notify.mobile_app_{{ device_attr(notify_device, 'name')
      | lower
      | replace(' ', '_')
      | replace('-', '_') }}

  notification_tag: >
    healthcheck_{{ running_sensor | replace('.', '_') }}

# ==============================================================================
# TRIGGERS
# ==============================================================================
trigger:
  # --------------------------------------------------------------------------
  # Trigger 1 : Service/Add-on arr√™t√©
  # Se d√©clenche quand : le capteur passe √† off pendant X minutes
  # Objectif : envoyer une alerte + (optionnel) rappels
  # --------------------------------------------------------------------------
  - platform: state
    entity_id: !input running_sensor
    to: "off"
    for:
      minutes: !input down_for_minutes
    id: down

  # --------------------------------------------------------------------------
  # Trigger 2 : Service/Add-on red√©marr√©
  # Se d√©clenche quand : le capteur repasse √† on
  # Objectif : notifier le retour √† la normale (et arr√™ter le rappel)
  # --------------------------------------------------------------------------
  - platform: state
    entity_id: !input running_sensor
    to: "on"
    id: up

# ==============================================================================
# ACTIONS
# ==============================================================================
action:
  - choose:
      # ------------------------------------------------------------------------
      # CAS 1 : Arr√™t d√©tect√© ‚Üí notification + rappels
      # ------------------------------------------------------------------------
      - conditions:
          - condition: trigger
            id: down
        sequence:
          - service: "{{ notify_service }}"
            data:
              title: "üõë {{ service_name }}"
              message: >
                üö® Service/Add-on arr√™t√© (capteur: {{ running_sensor }})
              data:
                tag: "{{ notification_tag }}"
                notification_icon: mdi:server-off
                ttl: 0
                priority: high

      # ------------------------------------------------------------------------
      # CAS 2 : Red√©marrage d√©tect√© ‚Üí notification retour √† la normale
      # ------------------------------------------------------------------------
      - conditions:
          - condition: trigger
            id: up
        sequence:
          - service: "{{ notify_service }}"
            data:
              title: "‚úÖ {{ service_name }}"
              message: >
                Le service/add-on a red√©marr√©.
              data:
                tag: "{{ notification_tag }}"
                notification_icon: mdi:check-circle
