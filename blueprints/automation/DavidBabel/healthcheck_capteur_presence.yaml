# Version: 1.0.8
# âœ… working
# Appartement: Romains
blueprint:
  name: "â¤ï¸ Health Check â€“ Surveillance DÃ©tecteurs de PrÃ©sence Aqara"
  description: >
    Version: 1.0.8
    Surveille vos dÃ©tecteurs de prÃ©sence Aqara et envoie une alerte critique
    lorsqu'un capteur devient inaccessible (pile faible, dÃ©connexion, etc.).
    Notification de retour Ã  la normale incluse.
  domain: automation
  # ==============================================================================
  # INPUTS - Configuration des paramÃ¨tres du blueprint
  # ==============================================================================
  input:
    # --------------------------------------------------------------------------
    # DÃ©tecteurs de prÃ©sence : capteurs Ã  surveiller
    # Type attendu : binary_sensor.xxx (dÃ©tecteurs Aqara ou similaires)
    # Valeur attendue : on/off/unavailable (on = prÃ©sence, unavailable = hors ligne)
    # --------------------------------------------------------------------------
    capteurs:
      name: ğŸ•µï¸ DÃ©tecteurs de prÃ©sence
      description: SÃ©lectionnez les dÃ©tecteurs de prÃ©sence Aqara Ã  surveiller
      default:
        - binary_sensor.detecteur_romains_communs_presence
      selector:
        entity:
          domain: binary_sensor
          multiple: true

    # --------------------------------------------------------------------------
    # DÃ©lai avant alerte : temps d'attente pour Ã©viter les fausses alertes
    # Type attendu : nombre entier
    # Valeur attendue : durÃ©e en minutes (recommandÃ© : 5)
    # --------------------------------------------------------------------------
    delai_avant_alerte:
      name: â±ï¸ DÃ©lai avant alerte
      description: Temps d'attente avant de dÃ©clencher l'alerte d'inaccessibilitÃ© (Ã©vite les fausses alertes)
      default: 5
      selector:
        number:
          min: 1
          max: 30
          unit_of_measurement: minutes

    # --------------------------------------------------------------------------
    # Intervalle de rappel : frÃ©quence des notifications rÃ©pÃ©titives
    # Type attendu : nombre entier
    # Valeur attendue : durÃ©e en minutes (recommandÃ© : 30)
    # --------------------------------------------------------------------------
    delai_rappel:
      name: ğŸ” Intervalle de rappel
      description: Temps entre deux notifications tant que le capteur est hors ligne
      default: 30
      selector:
        number:
          min: 5
          max: 180
          unit_of_measurement: minutes

    # --------------------------------------------------------------------------
    # Device de notification : appareil mobile recevant les alertes
    # Type attendu : device avec l'app mobile Home Assistant installÃ©e
    # --------------------------------------------------------------------------
    notify_device:
      name: ğŸ“± Device Ã  notifier
      description: Le device doit utiliser l'application mobile officielle Home Assistant.
      selector:
        device:
          filter:
            integration: mobile_app

# ==============================================================================
# MODE PARALLEL : Permet de surveiller plusieurs capteurs simultanÃ©ment
# ==============================================================================
mode: parallel
max: 10

# ==============================================================================
# TRIGGERS : Ã‰vÃ©nements qui dÃ©clenchent l'automation
# ==============================================================================
trigger:
  # --------------------------------------------------------------------------
  # Trigger 1 : Capteur inaccessible
  # Se dÃ©clenche quand : le capteur passe Ã  unavailable pendant X minutes
  # Objectif : dÃ©tecter une panne ou batterie faible
  # --------------------------------------------------------------------------
  - platform: state
    entity_id: !input capteurs
    to: "unavailable"
    for:
      minutes: !input delai_avant_alerte
    id: alerte

  # --------------------------------------------------------------------------
  # Trigger 2 : Capteur de retour en ligne
  # Se dÃ©clenche quand : le capteur sort de l'Ã©tat unavailable
  # Objectif : notifier le retour Ã  la normale
  # Note : Le dÃ©lai 'for' Ã©vite les fausses notifications au redÃ©marrage de HA
  # --------------------------------------------------------------------------
  - platform: state
    entity_id: !input capteurs
    from: "unavailable"
    for:
      minutes: 2
    id: retour

# ==============================================================================
# VARIABLES : PrÃ©paration des donnÃ©es pour les notifications
# ==============================================================================
variables:
  capteur: "{{ trigger.entity_id }}"
  nom: "{{ state_attr(trigger.entity_id, 'friendly_name') }}"
  rappel: !input delai_rappel
  notify_device: !input notify_device
  notify_service: >
    notify.mobile_app_{{ device_attr(notify_device, 'name')
      | lower
      | replace(' ', '_')
      | replace('-', '_') }}

action:
  # VÃ©rifier que Home Assistant est allumÃ© depuis au moins 5 minutes
  - condition: template
    value_template: >
      {{ (as_timestamp(now()) - as_timestamp(state_attr('homeassistant', 'last_boot'))) > 300 }}

  - choose:
      # =========================
      # ğŸš¨ CAPTEUR INACCESSIBLE
      # =========================
      - conditions:
          - condition: trigger
            id: alerte
        sequence:
          - repeat:
              while:
                - condition: template
                  value_template: "{{ states(capteur) == 'unavailable' }}"
              sequence:
                - service: "{{ notify_service }}"
                  data:
                    title: "ğŸš¨ CAPTEUR INACCESSIBLE"
                    message: >
                      âš ï¸ Le dÃ©tecteur de prÃ©sence est hors ligne !
                      ğŸ“ {{ nom }}
                    data:
                      tag: "presence_check_{{ capteur }}"
                      notification_icon: mdi:motion-sensor-off
                      push:
                        sound:
                          name: default
                          critical: 1
                          volume: 1.0
                      ttl: 0
                      priority: high
                      clickAction: /presence-salon/
                      url: /presence-salon/

                - delay:
                    minutes: "{{ rappel | int }}"

      # =========================
      # âœ… RETOUR EN LIGNE
      # =========================
      - conditions:
          - condition: trigger
            id: retour
        sequence:
          - service: "{{ notify_service }}"
            data:
              title: "âœ… Capteur rÃ©tabli"
              message: >
                ğŸŸ¢ Le dÃ©tecteur de prÃ©sence est de nouveau en ligne.
                ğŸ“ {{ nom }}
              data:
                tag: "presence_check_{{ capteur }}"
                notification_icon: mdi:motion-sensor
                clickAction: /presence-salon/
                url: /presence-salon/
