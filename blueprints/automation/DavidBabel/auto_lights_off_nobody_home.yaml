# Version: 1.0.6
# ‚úÖ working
# Appartement: Romains
blueprint:
  name: "üí° Extinction Auto - Personne √† la Maison"
  description: >
    Version: 1.0.6
    √âteint automatiquement les lumi√®res lorsque plus personne n'est pr√©sent dans le logement.
    Simple et efficace : d√©tection de pr√©sence ‚Üí extinction imm√©diate.
  domain: automation
  # ==============================================================================
  # INPUTS - Configuration des param√®tres du blueprint
  # ==============================================================================
  input:
    # --------------------------------------------------------------------------
    # Capteur de pr√©sence globale : d√©tection de pr√©sence dans le logement
    # Type attendu : binary_sensor.xxx (Helper > Template ou groupe)
    # Valeur attendue : on = pr√©sence d√©tect√©e, off = absence
    # --------------------------------------------------------------------------
    presence_sensor:
      name: üïµÔ∏è Capteur de pr√©sence globale
      description: Capteur binaire qui indique si quelqu'un est pr√©sent dans le logement
      default: binary_sensor.romains_anyone_is_present
      selector:
        entity:
          domain: binary_sensor

    # --------------------------------------------------------------------------
    # Lumi√®res √† contr√¥ler : interrupteurs switch
    # Type attendu : switch.xxx (interrupteurs/t√©l√©rupteurs)
    # Valeur attendue : on = allum√©, off = √©teint
    # --------------------------------------------------------------------------
    light_switches:
      name: üí° Lumi√®res √† √©teindre
      description: S√©lectionnez les interrupteurs de lumi√®res √† √©teindre automatiquement
      default:
        - switch.telerupteur_romains_lumieres_cuisine
        - switch.telerupteur_romains_lumieres_salon
      selector:
        entity:
          domain: switch
          multiple: true

    # --------------------------------------------------------------------------
    # Tracker d'√©v√©nements : suivi du d√©roulement de l'automation
    # Type attendu : input_select.xxx (Helper > Dropdown)
    # Valeur attendue : Options comme run, aborted_presence, lights_off, idle
    # Cr√©er via UI : Settings > Helpers > Create Helper > Dropdown
    # --------------------------------------------------------------------------
    automation_events_tracker:
      name: üßæ Tracker d'√©v√©nements d'automation
      description: Input select pour suivre les √©v√©nements de l'automation
      default: input_select.lights_automation_events
      selector:
        entity:
          domain: input_select

    # --------------------------------------------------------------------------
    # D√©lai de gr√¢ce : temps d'attente avant extinction
    # Type attendu : input_number.xxx (Helper > Number)
    # Valeur attendue : dur√©e en secondes (recommand√© : >= 40)
    # Cr√©er via UI : Settings > Helpers > Create Helper > Number
    # --------------------------------------------------------------------------
    grace_period_on_nobody_home:
      name: ‚è±Ô∏è D√©lai de gr√¢ce avant extinction
      description: >
        Entit√© input_number d√©finissant le temps d'attente apr√®s d√©tection d'absence avant d'√©teindre les lumi√®res.
        Permet d'√©viter une extinction imm√©diate si quelqu'un sort bri√®vement.
        Recommand√© : au moins 40 secondes. En dessous, uniquement pour les tests.
      default: input_number.duree_grace_period_on_light_on
      selector:
        entity:
          domain: input_number

    # --------------------------------------------------------------------------
    # Compteur d'extinctions : statistiques d'utilisation
    # Type attendu : counter.xxx (Helper > Counter)
    # Valeur attendue : nombre entier incr√©mental
    # Cr√©er via UI : Settings > Helpers > Create Helper > Counter
    # --------------------------------------------------------------------------
    auto_off_counter:
      name: üî¢ Compteur d'extinctions automatiques
      description: Entit√© counter qui compte le nombre de fois o√π l'automation a √©teint les lumi√®res
      default: counter.salon_lights_auto_off_count_nobody_here
      selector:
        entity:
          domain: counter

# ==============================================================================
# MODE SINGLE : Une seule ex√©cution √† la fois, les suivantes sont ignor√©es
# ==============================================================================
mode: single
max_exceeded: silent

# ==============================================================================
# TRIGGER : √âv√©nement qui d√©clenche l'automation
# ==============================================================================
trigger:
  # --------------------------------------------------------------------------
  # Trigger : D√©tection d'absence
  # Se d√©clenche quand : le capteur de pr√©sence passe √† off
  # Objectif : lancer le processus d'extinction des lumi√®res
  # --------------------------------------------------------------------------
  - platform: state
    entity_id: !input presence_sensor
    to: "off"

# ==============================================================================
# CONDITION : V√©rifications avant ex√©cution
# ==============================================================================
condition:
  # V√©rifie qu'au moins une lumi√®re est allum√©e avant d'agir
  # (√©vite de lancer l'automation inutilement)
  - condition: template
    value_template: >
      {% set switches = light_switches %}
      {{ switches | select('is_state', 'on') | list | count > 0 }}

# ==============================================================================
# VARIABLES : Pr√©paration des donn√©es pour l'action
# ==============================================================================
variables:
  light_switches: !input light_switches
  grace_period_entity: !input grace_period_on_nobody_home

# ==============================================================================
# ACTION : S√©quence d'extinction des lumi√®res
# ==============================================================================
action:
  # √âtat : d√©marrage
  - service: input_select.select_option
    target:
      entity_id: !input automation_events_tracker
    data:
      option: run

  # D√©lai de gr√¢ce apr√®s d√©tection d'absence
  - delay:
      seconds: "{{ states(grace_period_entity) | int }}"

  # Double v√©rification de la pr√©sence (s√©curit√©)
  - choose:
      - conditions:
          - condition: state
            entity_id: !input presence_sensor
            state: "on"
        sequence:
          - service: input_select.select_option
            target:
              entity_id: !input automation_events_tracker
            data:
              option: aborted_presence
          - delay:
              seconds: 20
          - service: input_select.select_option
            target:
              entity_id: !input automation_events_tracker
            data:
              option: idle
          - stop: Pr√©sence d√©tect√©e ‚Äì extinction annul√©e

  # Extinction des lumi√®res
  - service: switch.turn_off
    target:
      entity_id: !input light_switches

  # Incr√©mentation du compteur
  - service: counter.increment
    target:
      entity_id: !input auto_off_counter

  # √âtat : lumi√®res √©teintes
  - service: input_select.select_option
    target:
      entity_id: !input automation_events_tracker
    data:
      option: lights_off

  # Log de l'√©v√©nement
  - service: system_log.write
    data:
      level: info
      message: >
        Extinction automatique : plus personne pr√©sent.
        Lumi√®res √©teintes : {{ light_switches | join(', ') }}

  # Attente avant retour √† l'√©tat idle
  - delay:
      seconds: 20

  # √âtat : termin√© avec succ√®s
  - service: input_select.select_option
    target:
      entity_id: !input automation_events_tracker
    data:
      option: idle
