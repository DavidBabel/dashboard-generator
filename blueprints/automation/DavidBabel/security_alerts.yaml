# Version: 1.0.8
# âœ… working
# Appartement: Tous
blueprint:
  name: "ğŸ›¡ï¸ğŸ”¥ Urgence Maison â€“ Multi-capteurs (Eau / FumÃ©e / Autre)"
  description: >
    Version: 1.0.8
    Alerte critique avec rappel pÃ©riodique et notification de retour Ã  la normale.
    Compatible iOS (critique) et Android. Anti-spam intÃ©grÃ©.
  domain: automation
  # ==============================================================================
  # INPUTS - Configuration des paramÃ¨tres du blueprint
  # ==============================================================================
  input:
    # --------------------------------------------------------------------------
    # Capteurs de danger : dÃ©tecteurs de fuite d'eau, fumÃ©e, gaz, etc.
    # Type attendu : binary_sensor.xxx (dÃ©tecteurs de sÃ©curitÃ©)
    # Valeur attendue : on = danger dÃ©tectÃ©, off = normal
    # --------------------------------------------------------------------------
    capteurs:
      name: ğŸš¨ Capteurs de danger
      description: SÃ©lectionne un ou plusieurs capteurs (eau, fumÃ©e, gaz, etc.)
      default:
        - binary_sensor.detecteur_eau_engel_chauffe_eau_water_leak
        - binary_sensor.detecteur_eau_engel_cuisine_water_leak
        - binary_sensor.detecteur_eau_engel_salle_de_bains_water_leak
        - binary_sensor.detecteur_fumee_engel_entree_smoke
        - binary_sensor.detecteur_eau_romains_salle_de_bains_water_leak
        - binary_sensor.detecteur_eau_romains_cuisine_water_leak
        - binary_sensor.detecteur_eau_romains_douche_water_leak
        - binary_sensor.detecteur_fumee_romains_cellier_smoke
      selector:
        entity:
          domain: binary_sensor
          multiple: true

    # --------------------------------------------------------------------------
    # Intervalle de rappel : frÃ©quence des alertes rÃ©pÃ©titives
    # Type attendu : nombre entier
    # Valeur attendue : durÃ©e en minutes (recommandÃ© : 10)
    # --------------------------------------------------------------------------
    delai_rappel:
      name: ğŸ” Intervalle de rappel
      description: Temps entre deux notifications tant que le danger persiste
      default: 10
      selector:
        number:
          min: 1
          max: 60
          unit_of_measurement: minutes

    # --------------------------------------------------------------------------
    # Device de notification : appareil mobile recevant les alertes critiques
    # Type attendu : device avec l'app mobile Home Assistant installÃ©e
    # --------------------------------------------------------------------------
    notify_device:
      name: ğŸ“± Device Ã  notifier
      description: >
        Le device doit utiliser l'application mobile officielle Home Assistant.
      selector:
        device:
          filter:
            integration: mobile_app

# ==============================================================================
# MODE PARALLEL : Permet de gÃ©rer plusieurs alertes simultanÃ©ment
# ==============================================================================
mode: parallel
max: 10

# ==============================================================================
# TRIGGERS : Ã‰vÃ©nements qui dÃ©clenchent l'automation
# ==============================================================================
trigger:
  # --------------------------------------------------------------------------
  # Trigger 1 : Danger dÃ©tectÃ© (capteur passe Ã  on)
  # Se dÃ©clenche quand : fuite d'eau, fumÃ©e, ou autre danger dÃ©tectÃ©
  # Objectif : lancer immÃ©diatement les alertes critiques rÃ©pÃ©titives
  # --------------------------------------------------------------------------
  - platform: state
    entity_id: !input capteurs
    to: "on"
    id: alerte

  # --------------------------------------------------------------------------
  # Trigger 2 : Retour Ã  la normale (capteur passe Ã  off)
  # Se dÃ©clenche quand : le danger est Ã©cartÃ©
  # Objectif : notifier que la situation est revenue Ã  la normale
  # Note : Le dÃ©lai 'for' Ã©vite les fausses notifications au redÃ©marrage de HA
  # --------------------------------------------------------------------------
  - platform: state
    entity_id: !input capteurs
    to: "off"
    for:
      minutes: 2
    id: retour

# ==============================================================================
# VARIABLES : PrÃ©paration des donnÃ©es pour les notifications
# ==============================================================================
variables:
  capteur: "{{ trigger.entity_id }}"
  nom: "{{ state_attr(trigger.entity_id, 'friendly_name') }}"
  rappel: !input delai_rappel
  notify_device: !input notify_device
  notify_service: >
    notify.mobile_app_{{ device_attr(notify_device, 'name')
      | lower
      | replace(' ', '_')
      | replace('-', '_') }}

action:
  # VÃ©rifier que Home Assistant est allumÃ© depuis au moins 5 minutes
  - condition: template
    value_template: >
      {{ (as_timestamp(now()) - as_timestamp(state_attr('homeassistant', 'last_boot'))) > 300 }}

  - choose:
      # =========================
      # ğŸš¨ ALERTE ACTIVE
      # =========================
      - conditions:
          - condition: trigger
            id: alerte
        sequence:
          - repeat:
              while:
                - condition: template
                  value_template: "{{ is_state(capteur, 'on') }}"
              sequence:
                - service: "{{ notify_service }}"
                  data:
                    title: "ğŸš¨ ALERTE MAISON"
                    message: >
                      {% if 'smoke' in capteur %}
                      ğŸ”¥ FUMÃ‰E DÃ‰TECTÃ‰E
                      {% elif 'water' in capteur or 'leak' in capteur %}
                      ğŸ’§ FUITE Dâ€™EAU DÃ‰TECTÃ‰E
                      {% else %}
                      âš ï¸ DANGER DÃ‰TECTÃ‰
                      {% endif %}
                      ğŸ“ {{ nom }}
                    data:
                      tag: "urgence_{{ capteur }}"
                      notification_icon: mdi:alert
                      push:
                        sound:
                          name: default
                          critical: 1
                          volume: 1.0
                      ttl: 0
                      priority: high
                      url: /dashboard-alerts/
                      clickAction: /dashboard-alerts/

                - delay:
                    minutes: "{{ rappel | int }}"

      # =========================
      # âœ… RETOUR Ã€ LA NORMALE
      # =========================
      - conditions:
          - condition: trigger
            id: retour
        sequence:
          - service: "{{ notify_service }}"
            data:
              title: "âœ… Situation rÃ©tablie"
              message: >
                {% if 'smoke' in capteur %}
                ğŸ”¥ Fin de lâ€™alerte fumÃ©e
                {% elif 'water' in capteur or 'leak' in capteur %}
                ğŸ’§ Fin de lâ€™alerte fuite dâ€™eau
                {% else %}
                âš ï¸ Fin de lâ€™alerte
                {% endif %}
                ğŸ“ {{ nom }}
              data:
                tag: "urgence_{{ capteur }}"
                notification_icon: mdi:check-circle
                url: /dashboard-alerts/
                clickAction: /dashboard-alerts/
