# Version: 1.0.6
# ‚úÖ working
# Appartement: Tous
blueprint:
  name: "üîÑ Notification Red√©marrage Home Assistant"
  description: >
    Version: 1.0.6
    Envoie une notification lorsque Home Assistant red√©marre.
    Utile pour surveiller les red√©marrages automatiques ou manuels.
  domain: automation
  # ==============================================================================
  # INPUTS - Configuration des param√®tres du blueprint
  # ==============================================================================
  input:
    # --------------------------------------------------------------------------
    # Appartement : identification du site concern√©
    # Type attendu : s√©lection parmi les options d√©finies
    # Valeur attendue : emoji + nom d'appartement
    # --------------------------------------------------------------------------
    appartement:
      name: üè† Appartement
      description: S√©lectionnez l'appartement concern√©
      default: "üüß Engel"
      selector:
        select:
          options:
            - "üüß Engel"
            - "üü© Romains"
            - "üü¶ Carmes"

    # --------------------------------------------------------------------------
    # Device de notification : appareil mobile recevant les alertes
    # Type attendu : device avec l'app mobile Home Assistant install√©e
    # --------------------------------------------------------------------------
    notify_device:
      name: üì± Device √† notifier
      description: >
        Le device doit utiliser l'application mobile officielle Home Assistant.
      selector:
        device:
          filter:
            integration: mobile_app

    # --------------------------------------------------------------------------
    # D√©lai avant notification : temps d'attente apr√®s le d√©marrage
    # Type attendu : nombre entier
    # Valeur attendue : dur√©e en secondes (recommand√© : 30)
    # --------------------------------------------------------------------------
    notification_delay:
      name: ‚è±Ô∏è D√©lai avant notification
      description: Temps d'attente apr√®s le d√©marrage avant d'envoyer la notification (pour que tous les services soient pr√™ts)
      default: 30
      selector:
        number:
          min: 5
          max: 120
          unit_of_measurement: secondes

# ==============================================================================
# MODE SINGLE : Une seule ex√©cution √† la fois
# ==============================================================================
mode: single
max_exceeded: silent

# ==============================================================================
# VARIABLES : Pr√©paration des donn√©es pour les notifications
# ==============================================================================
variables:
  appartement: !input appartement
  notify_device: !input notify_device
  notify_service: >
    notify.mobile_app_{{ device_attr(notify_device, 'name')
      | lower
      | replace(' ', '_')
      | replace('-', '_') }}
  notification_delay: !input notification_delay

# ==============================================================================
# TRIGGER : D√©marrage de Home Assistant
# ==============================================================================
trigger:
  # --------------------------------------------------------------------------
  # Trigger : D√©marrage de Home Assistant
  # Se d√©clenche quand : Home Assistant d√©marre ou red√©marre
  # Objectif : notifier l'utilisateur du red√©marrage
  # --------------------------------------------------------------------------
  - platform: homeassistant
    event: start

# ==============================================================================
# ACTION : Envoi de la notification
# ==============================================================================
action:
  # D√©lai pour s'assurer que tous les services sont pr√™ts
  - delay:
      seconds: "{{ notification_delay }}"

  # Envoi de la notification
  - service: "{{ notify_service }}"
    data:
      title: "üîÑ {{ appartement }} - Home Assistant"
      message: "‚úÖ Home Assistant a red√©marr√© avec succ√®s !"
      data:
        notification_icon: mdi:restart
        tag: "ha_reboot_{{ appartement | lower }}"
        group: "system-notifications"
        channel: "System"
        importance: default

  # Log de l'√©v√©nement
  - service: system_log.write
    data:
      level: info
      message: "Notification de red√©marrage envoy√©e pour {{ appartement }}"
