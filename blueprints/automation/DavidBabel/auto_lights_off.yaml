# Version: 1.0.6
# ‚úÖ working
# Appartement: Romains
blueprint:
  name: "üí° Extinction Auto Lumi√®res (Pr√©sence Temporis√©e)"
  description: >
    Version: 1.0.6
    Extinction automatique des lumi√®res bas√©e sur un capteur de pr√©sence temporis√©e.
    Simple et efficace : le capteur g√®re d√©j√† la temporisation.
  domain: automation
  # ==============================================================================
  # INPUTS - Configuration des param√®tres du blueprint
  # ==============================================================================
  input:
    # --------------------------------------------------------------------------
    # Capteur de pr√©sence temporis√©e : d√©tection avec d√©lai int√©gr√©
    # Type attendu : binary_sensor.xxx (avec temporisation int√©gr√©e)
    # Valeur attendue : on = pr√©sence d√©tect√©e, off = absence prolong√©e
    # --------------------------------------------------------------------------
    presence_sensor:
      name: üïµÔ∏è Capteur de pr√©sence temporis√©e
      description: Le capteur binaire qui d√©tecte la pr√©sence (avec temporisation int√©gr√©e)
      default: binary_sensor.presence_communs_temporisee
      selector:
        entity:
          domain: binary_sensor

    # --------------------------------------------------------------------------
    # Lumi√®res √† contr√¥ler : interrupteurs switch
    # Type attendu : switch.xxx (interrupteurs/t√©l√©rupteurs)
    # Valeur attendue : on = allum√©, off = √©teint
    # --------------------------------------------------------------------------
    light_switches:
      name: üí° Lumi√®res √† √©teindre
      description: S√©lectionnez les interrupteurs de lumi√®res √† contr√¥ler
      default:
        - switch.telerupteur_romains_lumieres_cuisine
        - switch.telerupteur_romains_lumieres_salon
      selector:
        entity:
          domain: switch
          multiple: true

    # --------------------------------------------------------------------------
    # Tracker d'√©v√©nements : suivi du d√©roulement de l'automation
    # Type attendu : input_select.xxx (Helper > Dropdown)
    # Valeur attendue : Options comme run, aborted_presence, lights_off
    # Cr√©er via UI : Settings > Helpers > Create Helper > Dropdown
    # --------------------------------------------------------------------------
    automation_events_tracker:
      name: üßæ Tracker d'√©v√©nements d'automation
      description: Input select pour suivre les √©v√©nements de l'automation
      default: input_select.lights_automation_events
      selector:
        entity:
          domain: input_select

    # --------------------------------------------------------------------------
    # D√©lai de gr√¢ce : temps d'attente apr√®s allumage manuel
    # Type attendu : input_number.xxx (Helper > Number)
    # Valeur attendue : dur√©e en secondes (recommand√© : >= 40)
    # Cr√©er via UI : Settings > Helpers > Create Helper > Number
    # --------------------------------------------------------------------------
    grace_period_on_light_on:
      name: ‚è±Ô∏è D√©lai de gr√¢ce apr√®s allumage
      description: >
        Entit√© input_number d√©finissant le temps d'attente avant extinction si lumi√®re allum√©e alors que pas de pr√©sence.
        Recommand√© : au moins 40 secondes. En dessous, uniquement pour les tests.
      default: input_number.duree_grace_period_on_light_on
      selector:
        entity:
          domain: input_number

    # --------------------------------------------------------------------------
    # Compteur d'extinctions : statistiques d'utilisation
    # Type attendu : counter.xxx (Helper > Counter)
    # Valeur attendue : nombre entier incr√©mental
    # Cr√©er via UI : Settings > Helpers > Create Helper > Counter
    # --------------------------------------------------------------------------
    auto_off_counter:
      name: üî¢ Compteur d'extinctions automatiques
      description: Entit√© counter qui compte le nombre de fois o√π l'automation a √©teint les lumi√®res
      default: counter.salon_lights_auto_off_count
      selector:
        entity:
          domain: counter

# ==============================================================================
# MODE RESTART : Red√©marre l'automation si elle se d√©clenche pendant son ex√©cution
# ==============================================================================
mode: restart
max_exceeded: silent

# ==============================================================================
# TRIGGERS : √âv√©nements qui d√©clenchent l'automation
# ==============================================================================
trigger:
  # --------------------------------------------------------------------------
  # Trigger 1 : D√©tection d'absence
  # Se d√©clenche quand : le capteur de pr√©sence passe √† off
  # Objectif : lancer l'extinction des lumi√®res apr√®s temporisation
  # --------------------------------------------------------------------------
  - platform: state
    entity_id: !input presence_sensor
    to: "off"
    id: presence_off

  # --------------------------------------------------------------------------
  # Trigger 2 : Allumage manuel pendant absence
  # Se d√©clenche quand : une lumi√®re est allum√©e alors qu'il n'y a pas de pr√©sence
  # Objectif : √©teindre automatiquement apr√®s un d√©lai de gr√¢ce
  # --------------------------------------------------------------------------
  - platform: state
    entity_id: !input light_switches
    to: "on"
    id: light_turned_on

# ==============================================================================
# CONDITION : V√©rifications avant ex√©cution
# ==============================================================================
condition:
  # V√©rifie qu'au moins une lumi√®re est allum√©e avant d'agir
  # (√©vite de lancer l'automation inutilement)
  - condition: template
    value_template: >
      {% set switches = light_switches %}
      {{ switches | select('is_state', 'on') | list | count > 0 }}

# ==============================================================================
# VARIABLES : Pr√©paration des donn√©es pour l'action
# ==============================================================================
variables:
  light_switches: !input light_switches
  grace_period_entity: !input grace_period_on_light_on

# ==============================================================================
# ACTION : S√©quence d'extinction intelligente des lumi√®res
# ==============================================================================
action:
  # √âtat : d√©marrage
  - service: input_select.select_option
    target:
      entity_id: !input automation_events_tracker
    data:
      option: run

  # Si trigger = light_turned_on, v√©rifier que pr√©sence = OFF
  - choose:
      - conditions:
          - condition: trigger
            id: light_turned_on
          - condition: state
            entity_id: !input presence_sensor
            state: "on"
        sequence:
          - service: input_select.select_option
            target:
              entity_id: !input automation_events_tracker
            data:
              option: aborted_presence
          - delay:
              seconds: 20
          - service: input_select.select_option
            target:
              entity_id: !input automation_events_tracker
            data:
              option: idle
          - stop: Lumi√®re allum√©e mais pr√©sence d√©tect√©e

  # D√©lai de gr√¢ce si allumage manuel (trigger light_turned_on)
  - choose:
      - conditions:
          - condition: trigger
            id: light_turned_on
        sequence:
          - delay:
              seconds: "{{ states(grace_period_entity) | int }}"

  # Double v√©rification de la pr√©sence (s√©curit√©)
  - choose:
      - conditions:
          - condition: state
            entity_id: !input presence_sensor
            state: "on"
        sequence:
          - service: input_select.select_option
            target:
              entity_id: !input automation_events_tracker
            data:
              option: aborted_presence
          - delay:
              seconds: 20
          - service: input_select.select_option
            target:
              entity_id: !input automation_events_tracker
            data:
              option: idle
          - stop: Pr√©sence d√©tect√©e ‚Äì extinction annul√©e

  # Extinction des lumi√®res
  - service: switch.turn_off
    target:
      entity_id: !input light_switches

  # Incr√©mentation du compteur
  - service: counter.increment
    target:
      entity_id: !input auto_off_counter

  # √âtat : lumi√®res √©teintes
  - service: input_select.select_option
    target:
      entity_id: !input automation_events_tracker
    data:
      option: lights_off

  # Log de l'√©v√©nement
  - service: system_log.write
    data:
      level: info
      message: >
        Extinction auto valid√©e : absence confirm√©e via capteur de pr√©sence temporis√©e.
        Lumi√®res √©teintes : {{ light_switches | join(', ') }}

  # Attente avant retour √† l'√©tat idle
  - delay:
      seconds: 20

  # √âtat : termin√© avec succ√®s
  - service: input_select.select_option
    target:
      entity_id: !input automation_events_tracker
    data:
      option: idle
