# Version: 1.2.1
# ‚úÖ working
# Appartement: Tous
blueprint:
  name: "‚ù§Ô∏è Health Check ‚Äì Surveillance Connexion Prise Shelly"
  description: >
    Version: 1.2.1
    Envoie une alerte lorsqu'une prise Shelly est hors ligne pendant une dur√©e configurable
    et notifie quand elle revient en ligne.
  domain: automation
  # ==============================================================================
  # INPUTS - Configuration des param√®tres du blueprint
  # ==============================================================================
  input:
    # --------------------------------------------------------------------------
    # Capteur de connexion : sensor indiquant l'√©tat de la prise
    # Type attendu : binary_sensor.xxx (cr√©√© pour surveiller la prise Shelly)
    # Valeur attendue : on = connect√©e, off = hors ligne
    # --------------------------------------------------------------------------
    device_sensor:
      name: üîå Capteur de connexion
      description: Le capteur binaire qui indique l'√©tat de connexion de la prise Shelly
      default: binary_sensor.prise_shelly_connexion
      selector:
        entity:
          domain: binary_sensor

    # --------------------------------------------------------------------------
    # Appartement : identification du site concern√©
    # Type attendu : s√©lection parmi les options d√©finies
    # Valeur attendue : emoji + nom d'appartement
    # --------------------------------------------------------------------------
    appartement:
      name: üè† Appartement
      description: S√©lectionnez l'appartement concern√©
      default: "üüß Engel"
      selector:
        select:
          options:
            - "üüß Engel"
            - "üü© Romains"
            - "üü¶ Carmes"

    # --------------------------------------------------------------------------
    # Dur√©e hors ligne : d√©lai avant d√©clenchement de l'alerte
    # Type attendu : nombre entier
    # Valeur attendue : dur√©e en minutes (recommand√© : 10)
    # --------------------------------------------------------------------------
    offline_duration:
      name: ‚è±Ô∏è Dur√©e hors ligne avant alerte
      description: Temps d'attente avant d'envoyer l'alerte de d√©connexion
      default: 10
      selector:
        number:
          min: 1
          max: 120
          unit_of_measurement: minutes

    notify_device:
      name: üì± Device √† notifier
      description: >
        Le device doit utiliser l'application mobile officielle Home Assistant.
      selector:
        device:
          filter:
            integration: mobile_app

# ==============================================================================
# MODE RESTART : Red√©marre l'automation si elle se d√©clenche pendant son ex√©cution
# ==============================================================================
mode: restart

# ==============================================================================
# VARIABLES : Pr√©paration des donn√©es pour les notifications
# ==============================================================================
variables:
  appartement: !input appartement
  notify_device: !input notify_device
  notify_service: >
    notify.mobile_app_{{ device_attr(notify_device, 'name')
      | lower
      | replace(' ', '_')
      | replace('-', '_') }}
  device_name: "Prise Shelly {{ appartement }}"
  notification_tag: "alerte_shelly_{{ appartement | lower }}"
  offline_duration: !input offline_duration
  appartement_key: "{{ appartement.split(' ', 1)[1] | lower }}"
  power_switch: "switch.plug_chauffage_{{ appartement_key }}"

# ==============================================================================
# TRIGGER VARIABLES : Variables disponibles dans les triggers (ex: template trigger)
# Note : `variables:` n'est pas √©valu√© c√¥t√© trigger.
# ==============================================================================
trigger_variables:
  appartement: !input appartement
  appartement_key: "{{ appartement.split(' ', 1)[1] | lower }}"
  power_switch: "switch.plug_chauffage_{{ appartement_key }}"

# ==============================================================================
# TRIGGERS : √âv√©nements qui d√©clenchent l'automation
# ==============================================================================
trigger:
  # --------------------------------------------------------------------------
  # Trigger 1 : Prise d√©branch√©e (hors ligne)
  # Se d√©clenche quand : la prise est off pendant X minutes
  # Objectif : d√©tecter une panne ou une d√©connexion
  # --------------------------------------------------------------------------
  - platform: state
    entity_id: !input device_sensor
    to: "off"
    for:
      minutes: !input offline_duration
    id: debranche

  # --------------------------------------------------------------------------
  # Trigger 2 : Prise rebranch√©e (retour en ligne)
  # Se d√©clenche quand : la prise repasse de off √† on
  # Objectif : notifier le retour √† la normale
  # Note : Le d√©lai 'for' √©vite les fausses notifications au red√©marrage de HA
  # --------------------------------------------------------------------------
  - platform: state
    entity_id: !input device_sensor
    from: "off"
    to: "on"
    for:
      minutes: 1
    id: rebranche

  # --------------------------------------------------------------------------
  # Trigger 3 : Check quotidien
  # Se d√©clenche tous les jours √† 13:00
  # Objectif : v√©rifier que la prise alimente bien (switch = on)
  # --------------------------------------------------------------------------
  - platform: time
    at: "13:15:00"
    id: daily_check

  # --------------------------------------------------------------------------
  # Trigger 4/5 : Changement courant (switch)
  # D√©clench√© quand le switch de la prise change (OFF/ON)
  # Remarque : on utilise des template triggers car entity_id n'est pas templatable.
  # --------------------------------------------------------------------------
  - platform: template
    value_template: "{{ is_state(power_switch, 'off') }}"
    for:
      minutes: !input offline_duration
    id: courant_off

  - platform: template
    value_template: "{{ is_state(power_switch, 'on') }}"
    id: courant_on

action:
  - choose:
      - conditions:
          - condition: trigger
            id: courant_off
        sequence:
          - service: switch.turn_on
            target:
              entity_id: "{{ power_switch }}"

          - delay:
              seconds: 5

          - condition: template
            value_template: "{{ is_state(power_switch, 'off') }}"

          - service: "{{ notify_service }}"
            data:
              title: "‚ö° {{ device_name }}"
              message: "Alerte courant : la prise n'alimente plus (switch = OFF). Tentative de r√©activation effectu√©e, sans succ√®s."
              data:
                notification_icon: mdi:power-plug-off
                push:
                  sound:
                    name: default
                    critical: 1
                    volume: 1.0
                tag: "{{ notification_tag }}_courant"
                url: /dashboard-config/
                clickAction: /dashboard-config/

      - conditions:
          - condition: trigger
            id: courant_on
        sequence:
          - service: "{{ notify_service }}"
            data:
              title: "‚ö° {{ device_name }}"
              message: "Courant r√©tabli ‚úÖ (switch = ON)."
              data:
                notification_icon: mdi:power-plug
                tag: "{{ notification_tag }}_courant"
                url: /dashboard-config/
                clickAction: /dashboard-config/

      - conditions:
          - condition: trigger
            id: debranche
        sequence:
          - service: "{{ notify_service }}"
            data:
              title: "üîå {{ device_name }}"
              message: "La prise Shelly est hors ligne depuis {{ offline_duration }} minutes"
              data:
                notification_icon: mdi:power-plug-off
                push:
                  sound:
                    name: default
                    critical: 1
                    volume: 1.0
                tag: "{{ notification_tag }}"
                url: /dashboard-config/
                clickAction: /dashboard-config/
      - conditions:
          - condition: trigger
            id: rebranche
        sequence:
          - service: "{{ notify_service }}"
            data:
              title: "üîå {{ device_name }}"
              message: "La prise Shelly est de nouveau connect√©e ‚úÖ"
              data:
                notification_icon: mdi:power-plug
                tag: "{{ notification_tag }}"
                url: /dashboard-config/
                clickAction: /dashboard-config/

      - conditions:
          - condition: trigger
            id: daily_check
          - condition: state
            entity_id: !input device_sensor
            state: "on"
          - condition: template
            value_template: "{{ is_state(power_switch, 'off') }}"
        sequence:
          - service: switch.turn_on
            target:
              entity_id: "{{ power_switch }}"

          - delay:
              seconds: 5

          - condition: template
            value_template: "{{ is_state(power_switch, 'off') }}"

          - service: "{{ notify_service }}"
            data:
              title: "‚ö° {{ device_name }}"
              message: "Alerte courant : la prise est connect√©e, mais n'alimente pas (switch = OFF). Tentative de r√©activation effectu√©e, sans succ√®s."
              data:
                notification_icon: mdi:power-plug-off
                push:
                  sound:
                    name: default
                    critical: 1
                    volume: 1.0
                tag: "{{ notification_tag }}_courant"
                url: /dashboard-config/
                clickAction: /dashboard-config/
